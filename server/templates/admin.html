<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Admin Panel</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: #f8f9fa; }
        .header { background-color: #343a40; color: white; padding: 1em 2em; }
        .container { max-width: 1600px; margin: auto; padding: 2em; }
        .card { background-color: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5em; }
        .response { white-space: pre-wrap; background-color: #e9ecef; padding: 1em; border: 1px solid #dee2e6; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        input, select { width: 100%; padding: 8px; margin-bottom: 1em; border-radius: 4px; border: 1px solid #ced4da; box-sizing: border-box; }
        .main-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 2em; }
        .camera-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5em; }
        .camera-card { border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        .camera-card h3 { margin: 0; padding: 0.5em; background-color: #f8f9fa; }
        .camera-card img { width: 100%; height: auto; display: block; }
        .camera-card .status { padding: 0.5em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>SingaPlayGO Control Center</h1>
    </div>
    <div class="container">
        <div class="main-layout">
            <div>
                <div class="card">
                    <h2>Live Camera Feeds</h2>
                    <div id="camera-gallery" class="camera-gallery">
                        <p>Awaiting camera connections...</p>
                    </div>
                </div>
            </div>
            <div>
                <div class="card">
                    <h2>Process Turn</h2>
                    <form id="process-turn-form">
                        <p>
                            <label for="game_session_id">Game Session ID:</label>
                            <input type="text" id="game_session_id" name="game_session_id" value="game-01">
                        </p>
                        <p>
                            <label for="esp32_id_select">Use Image From:</label>
                            <select id="esp32_id_select" name="esp32_id" required></select>
                        </p>
                        <p>
                            <label for="character_image">Upload Character/Object Image:</label>
                            <input type="file" id="character_image" name="character_image" accept="image/*" required>
                        </p>
                        <button type="submit">Process with Gemini</button>
                    </form>
                </div>
                <div class="card" style="margin-top: 2em;">
                    <h2>Gemini Response</h2>
                    <pre id="response" class="response">Awaiting request...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gallery = document.getElementById('camera-gallery');
        const esp32Select = document.getElementById('esp32_id_select');
        const responseElement = document.getElementById('response');

        async function updateStatus() {
            try {
                const response = await fetch('/admin/status');
                const data = await response.json();

                gallery.innerHTML = '';
                esp32Select.innerHTML = '';

                if (Object.keys(data.esp32_devices).length === 0) {
                    gallery.innerHTML = '<p>No ESP32 devices have connected yet.</p>';
                } else {
                    for (const [id, device] of Object.entries(data.esp32_devices)) {
                        // Add to gallery
                        const card = document.createElement('div');
                        card.className = 'camera-card';
                        
                        const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
                        const lastSeen = new Date(device.last_seen).toLocaleString();
                        
                        let imageHtml = '<p>No image received yet.</p>';
                        if (data.latest_images[id]) {
                            imageHtml = `<img src="${data.latest_images[id]}?t=${new Date().getTime()}" alt="Latest image from ${id}">`;
                        }

                        card.innerHTML = `
                            <h3>${id}</h3>
                            ${imageHtml}
                            <div class="status">
                                <span class="${statusClass}">${device.status}</span><br>
                                <small>Last seen: ${lastSeen}</small>
                            </div>
                        `;
                        gallery.appendChild(card);

                        // Add to select dropdown
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = id;
                        esp32Select.appendChild(option);
                    }
                }
            } catch (error) {
                gallery.innerHTML = '<p>Error fetching status.</p>';
                console.error('Status update error:', error);
            }
        }

        document.getElementById('process-turn-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData();
            formData.append('character_image', document.getElementById('character_image').files[0]);

            const gameSessionId = document.getElementById('game_session_id').value;
            const esp32Id = esp32Select.value;
            
            if (!esp32Id) {
                responseElement.textContent = 'Please select an ESP32 device to use its image.';
                return;
            }

            const url = `/admin/process-turn?esp32_id=${esp32Id}&game_session_id=${gameSessionId}`;

            responseElement.textContent = 'Sending to Gemini for processing...';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = 'Error: ' + error.message;
            }
        });

        updateStatus();
        setInterval(updateStatus, 3000); // Update more frequently
    </script>
</body>
</html>
